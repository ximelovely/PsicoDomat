<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda tu cita</title>
    <link rel="stylesheet" href="Agenda.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="fig">
            <div class="Titu">Agenda tu cita</div>
            <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #77B2A6;">
                <div class="container-fluid">
                    <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <img src="/IM√ÅGENES/menu-icon.png" alt="Men√∫" class="menu-icon">
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="/IM√ÅGENES/menu-icon.png" alt="Men√∫" class="menu-icon">
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="Agenda.html">Agenda tu cita</a></li>
                                    <li><a class="dropdown-item" href="Ubi.html">Ubicaci√≥n de sucursales</a></li>
                                    <li><a class="dropdown-item" href="Conoce.html">Conoce a tu doctora</a></li>
                                    <li><a class="dropdown-item" href="#" id="sigue-cita-link">Sigue tu cita</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="Agenda">
        <div class="formu">
            <form class="form-container">
                <div class="input-group">
                    <label for="sucursal">Sucursal elegida:</label>
                    <select id="sucursal" name="sucursal" required>
                        <option disabled selected>Selecciona una sucursal</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="fecha">Fecha de la cita:</label>
                    <input type="date" id="fecha" name="fecha" required>
                </div>
                <div class="input-group">
                    <label for="hora">Hora de la cita:</label>
                    <select id="hora" name="hora" required>
                        <option disabled selected>Selecciona una hora</option>
                    </select>

                </div>
                <div class="input-group">
                    <label for="motivo">Motivo de consulta:</label>
                    <select id="motivo" name="motivo" required>
                        <option disabled selected>Selecciona un motivo</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="snoopypsi">
            <img src="/IM√ÅGENES/snoopy.png" alt="Agenda" class="imagen">
        </div>

        <!MENAJE PARA BACK!>
        <!El mensaje se mostrar√° diferente dependiendo de donde escogi√≥ la sucursal, si eligi√≥ mx 599, eu 50!>
        <div class="precio">El precio en cada servicio es de $599MXN o $50USD</div>
        </div>
        <div class"Bot√≥n">
            <button type="submit" class="agendar">Agendar</button>
        </div>
        <div class="mensaje">
            La hora y fecha de la cita puede cambiar a disponibilidad de la doctora</div>
    </div>

    <!-- Bootstrap JS NO BORRAR -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
console.log("‚öôÔ∏è Script cargado");

document.addEventListener('DOMContentLoaded', async () => {
    const telefono = localStorage.getItem('telefono');
    console.log("üìû Tel√©fono en localStorage:", telefono);

    const sigueLink = document.getElementById('sigue-cita-link');
    if (!telefono) {
        window.location.href = "Sesion.html";
        return;
    }

    if (sigueLink) {
        try {
            const response = await fetch('http://localhost:3000/tiene-cita', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telefono })
            });
            const data = await response.json();
            sigueLink.href = data.tieneCita ? "Sigue.html" : "nocita.html";
        } catch (error) {
            sigueLink.href = "Sesion.html";
        }
    }

    const sucursalSelect = document.getElementById('sucursal');
    const motivoSelect = document.getElementById('motivo');
    const horaSelect = document.getElementById('hora');

    // Cargar sucursales
    console.log("üåê Cargando sucursales...");
    try {
        const sucursalRes = await fetch('http://localhost:3000/sucursales');
        const sucursales = await sucursalRes.json();
        console.log("üìç Sucursales recibidas:", sucursales);
        sucursales.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.ID_Sucursal;
            opt.textContent = s.Nombre;
            sucursalSelect.appendChild(opt);
        });
    } catch (err) {
        console.error("‚ùå Error cargando sucursales", err);
    }

    // Cargar servicios
    console.log("üß† Cargando servicios...");
    try {
        const serviciosRes = await fetch('http://localhost:3000/servicios');
        const servicios = await serviciosRes.json();
        console.log("‚úÖ Servicios recibidos:", servicios);
        servicios.forEach(serv => {
            const opt = document.createElement('option');
            opt.value = serv.ID_Servicio;
            opt.textContent = serv.Descripcion;
            motivoSelect.appendChild(opt);
        });
    } catch (err) {
        console.error("‚ùå Error cargando servicios", err);
    }

    // Cargar horarios cuando se seleccione una sucursal
        sucursalSelect.addEventListener('change', cargarHorarios);
document.getElementById('fecha').addEventListener('change', cargarHorarios);

async function cargarHorarios() {
    const idSucursal = parseInt(sucursalSelect.value);
    const fecha = document.getElementById('fecha').value;
    if (!idSucursal || !fecha) return;

    horaSelect.innerHTML = '<option disabled selected>Selecciona una hora</option>';

    try {
        const res = await fetch('http://localhost:3000/horarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idSucursal, fecha })
        });
        const horas = await res.json();
        console.log("üïí Horarios disponibles:", horas);

        horas.forEach(h => {
            const opt = document.createElement('option');
            opt.value = h.ID_Hora;
            opt.textContent = h.Hora;
            horaSelect.appendChild(opt);
        });
    } catch (err) {
        console.error("‚ùå Error cargando horarios:", err);
    }
}
});

document.querySelector('.agendar').addEventListener('click', async () => {
    const telefono = localStorage.getItem('telefono');
    const fecha = document.getElementById('fecha').value;
    const idSucursal = document.getElementById('sucursal').value;
    const idHora = document.getElementById('hora').value;
    const idServicio = document.getElementById('motivo').value;

    if (!telefono || !fecha || !idSucursal || !idHora || !idServicio) {
        alert("‚ö†Ô∏è Todos los campos son obligatorios");
        return;
    }

    try {
        const res = await fetch('http://localhost:3000/agendar-cita', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telefono, fecha, idHora, idServicio, idSucursal })
        });
        const data = await res.json();
        if (data.success) {
            alert("‚úÖ Cita agendada correctamente");
            window.location.href = "Sigue.html";
        } else {
            alert("‚ùå No se pudo agendar: " + data.error);
        }
    } catch (err) {
        console.error("Error al enviar cita", err);
        alert("‚ùå Error al conectar con el servidor");
    }
});

</script>


</body>
</html>